name: Master Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - uses: actions/checkout@v2

      - name: Make Merkely owner available for following steps
        run: |
          echo "MERKELY_OWNER=compliancedbb" >> ${GITHUB_ENV}


      - name: Make name of Merkely pipeline available for following steps
        run: |
          echo "MERKELY_PIPELINE=loancalculator" >> ${GITHUB_ENV}


      - name: Make Docker image names available for following steps
        run: |
          echo "IMAGE_TAGGED=${{ secrets.DOCKERHUB_REPO_OWNER }}/loancalculator:$(git log -1 --pretty=%h)" >> ${GITHUB_ENV}
          echo "IMAGE_LATEST=${{ secrets.DOCKERHUB_REPO_OWNER }}/loancalculator:latest" >> ${GITHUB_ENV}


      - name: Declare Merkely Pipeline
        uses: docker://merkely/change:latest
        env:
          MERKELY_COMMAND: declare_pipeline
          MERKELY_OWNER: $${ env.MERKELY_OWNER }}
          MERKELY_PIPELINE: $${ env.MERKELY_PIPELINE }}
          MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
          MERKELY_PIPE_PATH: ${{ github.workspace }}/Merkelypipe.json


      - name: Build and Publish Docker Image
        run: |
          docker build --file ${PWD}/Dockerfile --tag ${{ env.IMAGE_TAGGED }} ${PWD}
          docker tag ${{ env.IMAGE_TAGGED }} ${{ env.IMAGE_LATEST }}
          echo ${{ secrets.DOCKERHUB_DEPLOY_TOKEN }} | docker login --username ${{ secrets.DOCKERHUB_DEPLOY_USERNAME }} --password-stdin
          docker push ${{ env.IMAGE_TAGGED }}
          docker push ${{ env.IMAGE_LATEST }}


      - name: Log Docker Image in Merkely
        uses: docker://merkely/change:latest
        env:
          MERKELY_COMMAND: log_artifact
          MERKELY_OWNER: $${ env.MERKELY_OWNER }}
          MERKELY_PIPELINE: $${ env.MERKELY_PIPELINE }}
          MERKELY_FINGERPRINT: docker://${{ env.IMAGE_TAGGED }}
          MERKELY_IS_COMPLIANT: "TRUE"
          MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
          MERKELY_PIPE_PATH: ${{ github.workspace }}/Merkelypipe.json


      - name: Run Unit Tests
        run: |
          # Write results to ./build/test/
          docker run \
              --name container \
              --entrypoint ./entrypoint-unit_test.sh \
              ${{ env.IMAGE_TAGGED }}
          mkdir -p build/test
          docker cp container:/code/build/test/ ${PWD}/build
          docker rm container


      - name: Log Unit Test Results in Merkely
        uses: docker://merkely/change:latest
        env:
          MERKELY_COMMAND: log_test
          MERKELY_OWNER: $${ env.MERKELY_OWNER }}
          MERKELY_PIPELINE: $${ env.MERKELY_PIPELINE }}
          MERKELY_FINGERPRINT: docker://${{ env.IMAGE_TAGGED }}
          MERKELY_EVIDENCE_TYPE: unit_test
          MERKELY_TEST_RESULTS_DIR: ${{ github.workspace}}/build/test
          MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
          MERKELY_PIPE_PATH: ${{ github.workspace }}/Merkelypipe.json


      - name: Run Security Analysis
        run: |
          # Run bandit security. Write results to ./build/security/
          mkdir -p build/security
          docker run \
                  --rm \
                  --volume ${PWD}/build:/code/build \
                  --entrypoint ./entrypoint-security.sh \
                  ${{ env.IMAGE_TAGGED }}


      - name: Log Security Results in Merkely
        uses: docker://merkely/change:latest
        env:
          MERKELY_COMMAND: log_test
          MERKELY_OWNER: $${ env.MERKELY_OWNER }}
          MERKELY_PIPELINE: $${ env.MERKELY_PIPELINE }}
          MERKELY_FINGERPRINT: docker://${{ env.IMAGE_TAGGED }}
          MERKELY_EVIDENCE_TYPE: security
          MERKELY_TEST_RESULTS_DIR: ${{ github.workspace }}/build/security
          MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
          MERKELY_PIPE_PATH: ${{ github.workspace }}/Merkelypipe.json


      - name: Run Coverage
        run: |
          # Write summary to build/coverage/coverage_summary.sh
          mkdir -p build/coverage
          docker run \
                  --rm \
                  --volume ${PWD}/build:/code/build \
                  --entrypoint ./entrypoint-coverage.sh \
                  ${{ env.IMAGE_TAGGED }}
          source build/coverage/coverage_summary.sh
          echo "COVERAGE_SUMMARY=${COVERAGE_SUMMARY}" >> ${GITHUB_ENV}


      - name: Log Coverage Results in Merkely
        uses: docker://merkely/change:latest
        env:
          MERKELY_COMMAND: log_evidence
          MERKELY_OWNER: $${ env.MERKELY_OWNER }}
          MERKELY_PIPELINE: $${ env.MERKELY_PIPELINE }}
          MERKELY_FINGERPRINT: docker://${{ env.IMAGE_TAGGED }}
          MERKELY_EVIDENCE_TYPE: coverage
          MERKELY_IS_COMPLIANT: "TRUE"
          MERKELY_DESCRIPTION: ${{ env.COVERAGE_SUMMARY }}
          MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
          MERKELY_PIPE_PATH: ${{ github.workspace }}/Merkelypipe.json


      - name: Deploy to staging
        run: |
          echo YOUR DEPLOYMENT COMMAND HERE


      - name: Log Deployment to staging in Merkely
        uses: docker://merkely/change:latest
        env:
          MERKELY_COMMAND: log_deployment
          MERKELY_OWNER: $${ env.MERKELY_OWNER }}
          MERKELY_PIPELINE: $${ env.MERKELY_PIPELINE }}
          MERKELY_FINGERPRINT: docker://${{ env.IMAGE_TAGGED }}
          MERKELY_DESCRIPTION: "Deployed to staging in pipeline"
          MERKELY_ENVIRONMENT: staging
          MERKELY_API_TOKEN: ${{ secrets.MERKELY_API_TOKEN }}
          MERKELY_PIPE_PATH: ${{ github.workspace }}/Merkelypipe.json
